{% extends "base.html" %}

{% block title %}Latest Revisions - Code Reviser UI{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Latest Revisions</h2>
    <div id="revisions"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$(document).ready(function() {
    getLatestRevisions().then(revisions => {
        let container = $('#revisions');
        revisions.forEach(revision => {
            container.append(`
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${revision.id}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${revision.id}" aria-expanded="false" aria-controls="collapse${revision.id}">
                            ${revision.filename} - Revision ${revision.revision_id}
                        </button>
                    </h2>
                    <div id="collapse${revision.id}" class="accordion-collapse collapse" aria-labelledby="heading${revision.id}" data-bs-parent="#revisions">
                        <div class="accordion-body">
                            <form method="post" action="{{ url_for('edit_revision', filename=${revision.filename}, revision_id=${revision.revision_id}) }}">
                                <input type="hidden" name="filename" value="${revision.filename}">
                                <input type="hidden" name="revision_id" value="${revision.revision_id}">
                                <textarea class="form-control" id="new_content_${revision.id}" name="new_content" rows="20" required>${revision.content}</textarea>
                                <textarea class="form-control" id="new_instruction_${revision.id}" name="new_instruction" rows="5" required>${revision.initial_instruction}</textarea>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            `);
        });

        $('.accordion-button').click(function() {
            $(this).next().toggleClass('show');
            $(this).parent().toggleClass('active');
        });
    });
});

async function getLatestRevisions() {
    const response = await fetch('/get_latest_revisions');
    const data = await response.json();
    return data;
}
</script>
{% endblock %}